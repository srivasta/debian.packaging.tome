<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
 <title>T.o.M.E. Documentation</title>
 <meta name="description" content="ToME and TomeNET homepage. ToME is a roguelike dungeon exploration game, based on Angband.">
 <meta name="keywords" content="angband, tome, tomenet, library, angband, official, roguelike">
</head>
<body bgcolor="#000000" text="#FFFFFF" link="#CC0000" alink="#FF9900" vlink="#FFCC66">
<FONT text="#CCCCCC">
<PRE><TT>
<FONT COLOR="#FF0000">             /----------------------------------------\</FONT>
<FONT COLOR="#FF0000">            <         Adding new racial powers         ></FONT>
<FONT COLOR="#FF0000">             \----------------------------------------/</FONT>

<FONT COLOR="#FF0000">=== Introduction ===</FONT>

You *must* download and install my lua example files from 
<FONT COLOR="#00FF00">http://www.moppy.co.uk/angband.htm</FONT>. And also you should read the 
<A HREF="lua_intr.html">scripting introduction</A> file if you haven't already done 
so.

The (commented) accompanying script file for this tutorial is 
lib\scrpt\pheonix.lua. Open it in your text editor!

<FONT COLOR="#FF0000">=== The Racial Power ===</FONT>

Let's start with something simple. Let's say you wanted your new race (let's 
call it "Pheonix") to be able to cast fire balls as their racial power. 

<FONT COLOR="#FF0000">=== Starting off ===</FONT>

If you have a look at pheonix.lua you'll note the first lines are comments.
I'll talk a bit more about comments later, but it's worth pointing out that any
lines of text preceded by a double hyphen (<FONT COLOR="#00FFFF">--</FONT>) will be ignored by the 
scripting engine, and are therefore comments. 
After the comments, the first 10 lines of code are as follows:

<FONT COLOR="#00FFFF">PHEONIX_POWER = add_power</FONT>
<FONT COLOR="#00FFFF">{</FONT>
<FONT COLOR="#00FFFF">        ["name"] =      "Fire Breath",</FONT>
<FONT COLOR="#00FFFF">        ["desc"] =      "You are able to cast fireballs",</FONT>
<FONT COLOR="#00FFFF">        ["desc_get"] =  "Your beak glows red",</FONT>
<FONT COLOR="#00FFFF">        ["desc_lose"] = "Your beak goes cold again",</FONT>
<FONT COLOR="#00FFFF">        ["level"] =     10,</FONT>
<FONT COLOR="#00FFFF">        ["cost"] =      11,</FONT>
<FONT COLOR="#00FFFF">        ["stat"] =      A_INT,</FONT>
<FONT COLOR="#00FFFF">        ["fail"] =      14,</FONT>

So, <FONT COLOR="#00FFFF">PHEONIX_POWER = add_power</FONT> is registering our power. We're giving it 
a name (PHEONIX_POWER) and saying that it is defined by calling the special 
function <FONT COLOR="#00FFFF">add_power</FONT>. This special function is only used to define lua-
scripted 
powers, and has attributes which are identified by their inclusion in square 
brackets.
Note the following:
- Lua is case sensitive. The name of our power is a constant, will never change 
so that's been named with capitals. variables and functions are named all in 
lower case. Technically speaking, Lua does not support constants, but we can 
emulate them by variables in this way. They don't have to be capitalised, but 
if you capitalise all your constants, it makes things easier to read, and 
you'll be following normal programming protocol. 
- There are no spaces in the name of the power. Use an underscore for spaces 
if you need to improve legibility. 

<FONT COLOR="#00FFFF">"name" =      "Fire Breath",</FONT> This is the name of the power as it is 
displayed in the 
U menu, and as you will define it in p_info.txt (more about that later). 

<FONT COLOR="#00FFFF">"desc" =      "You are able to cast fireballs",</FONT> This is what would 
appear in the 
information display list if you drank  a potion of self knowledge or 
similar. 

<FONT COLOR="#00FFFF">"desc_get" =  "Your beak glows red",</FONT> This is the information displayed 
when you 
gain this power. 

<FONT COLOR="#00FFFF">"desc_lose" = "Your beak goes cold again",</FONT> This is the information 
displayed when 
you lose this power. Eg After a mutation/corruption.

<FONT COLOR="#00FFFF">"level" =     10,</FONT> Character level which must be gained in order to use 
power,

<FONT COLOR="#00FFFF">"cost" =      11,</FONT> Amount of mana to cast this power.

<FONT COLOR="#00FFFF">"stat" =      A_INT,</FONT> stat which will define whether it works or not, 

<FONT COLOR="#00FFFF">"fail" =      14,</FONT> how high that stat must be. 

So our Pheonix will be able to cast PHEONIX_POWER  from clvl 10, at a cost of 
11 mana, providing that the player's intelligence is 14 and upwards. 

<FONT COLOR="#FF0000">=== The function ===</FONT>

The next section is a lot longer, so we'll look at it line by line. I'll 
strip the comments for the purpose of this helpfile.

<FONT COLOR="#00FFFF">["power"] =     function()</FONT>
<FONT COLOR="#00FFFF">          local ret, dir, damage</FONT>
<FONT COLOR="#00FFFF">          ret, dir = get_aim_dir();</FONT>
<FONT COLOR="#00FFFF">          if (ret == FALSE) then </FONT>
<FONT COLOR="#00FFFF">                  return </FONT>
<FONT COLOR="#00FFFF">          end</FONT>
<FONT COLOR="#00FFFF">          damage = player.lev*3</FONT>
<FONT COLOR="#00FFFF">          msg_print("You breathe fire.")</FONT>
<FONT COLOR="#00FFFF">          fire_ball(GF_FIRE, dir, damage, 3)</FONT>
<FONT COLOR="#00FFFF">end,</FONT>

The <FONT COLOR="#00FFFF">"power"</FONT> bit is what actually happens when the player accesses this 
power 
from their 'U' menu. Every function must start with the word <FONT COLOR="#00FFFF">function</FONT>. 
Normally, we'd also declare its name at this point, but as this is contained 
within the <FONT COLOR="#00FFFF">add_power</FONT> function, we just use the word <FONT COLOR="#00FFFF">function</FONT> The 
empty 
brackets after this denote that no arguments are passed to the function. 
Lets look at the next line.

<FONT COLOR="#00FFFF">          local ret, dir, damage</FONT>

The <FONT COLOR="#00FFFF">local</FONT> bit is saying that  we're going to declare some local 
variables. That 
is, that there will be three variables used in this function , that apply 
exclusively to this function, and to no others. Global variables are 
variables that apply to the whole script, in multiple functions. The three 
variables will be called <FONT COLOR="#00FFFF">ret</FONT> (return), <FONT COLOR="#00FFFF">dir</FONT> (direction), and
<FONT COLOR="#00FFFF">damage</FONT>. They will be used to determine the direction the ball 
will fire in, and how much damage it will do. We'll see them in use when we add
the third line:

<FONT COLOR="#00FFFF">          ret, dir = get_aim_dir();</FONT>

here we're saying that the variables will take their value from the result 
of a function. The program performs the function <FONT COLOR="#00FFFF">get_aim_dir</FONT> which 
essentially asks the player to choose a direction or pick a target. 
<FONT COLOR="#00FFFF">get_aim_dir</FONT> 
assigns the value <FONT COLOR="#00FFFF">ret</FONT> to either TRUE (if the player correctly selected a 
direction) or FALSE (if the player failed to do so (maybe they changed their 
mind, or hit the wrong key!)). The value <FONT COLOR="#00FFFF">dir</FONT> is the direction which was 
selected (or the path to the target if a target was selected). OK so let's add 
the next line:

<FONT COLOR="#00FFFF">          if (ret == FALSE) then return end</FONT>

This introduces another fundamental scripting concept - <FONT COLOR="#00FFFF">if</FONT> statements.
They work just as you would expect them too. You say "if a certain condition is
met, then do the following things."
So in this function we're saying, "if the value of <FONT COLOR="#00FFFF">ret</FONT> is FALSE then 
<FONT COLOR="#00FFFF">return</FONT>."
As I mentioned above, <FONT COLOR="#00FFFF">ret</FONT> is false if the player aborted (either 
deliberately or accidentally) the spell casting whilst choosing a direction 
for the spell. The double equals sign are used to mean "is equal to" as a 
single equals sign is used for defining variables remember? A single equals 
sign is more of a "let x be equal to y" thing.
<FONT COLOR="#00FFFF">return</FONT> means stop the current function. And <FONT COLOR="#00FFFF">end</FONT> signifies the 
close of the <FONT COLOR="#00FFFF">if</FONT>
statement. Every <FONT COLOR="#00FFFF">if</FONT> statement must begin with an <FONT COLOR="#00FFFF">if</FONT> and finish 
with an <FONT COLOR="#00FFFF">end</FONT>.
So, what our <FONT COLOR="#00FFFF">if</FONT> statement is saying is; "if the player failed to specify 
a direction or target for the spell, stop the function here."
If the player has correctly specified a direction/target, the function 
continues to the next line:

<FONT COLOR="#00FFFF">          damage = player.lev*3</FONT>

Here we're saying that the variable <FONT COLOR="#00FFFF">damage</FONT> has a value equal to the 
players current character level, multiplied by 3.

<FONT COLOR="#00FFFF">          msg_print("You breathe fire.")</FONT>

Fairly easy to see what this does - displays the message "You breathe fire."
I could have put anything there obviously, like <FONT COLOR="#00FFFF">msg_print("You open</FONT>
<FONT COLOR="#00FFFF">your mouth and everyone falls over with the smell of hot curry")</FONT> or
some other such rubbish. But note that the message is enclosed within double 
quotes. The quotes aren't displayed in the message on screen, but signify the 
start and end of the message. 

<FONT COLOR="#00FFFF">          fire_ball(GF_FIRE, dir, damage, 3)</FONT>

This is the line that casts the spell. it says execute the function 
<FONT COLOR="#00FFFF">fire_ball</FONT>. Now, this doesn't mean a fireball, it means fire a ball. 
There's an important distinction there! All it knows it is doing is firing a 
ball, it doesn't know what kind of ball, or where, or how big, or how much 
damage.
The <FONT COLOR="#00FFFF">GF_FIRE,</FONT> bit is what tell us it is a fire ball. If it was 
<FONT COLOR="#00FFFF">GF_COLD,</FONT>
 we'd have a cold ball, or <FONT COLOR="#00FFFF">GF_CHAOS,</FONT> it would be a chaos ball and 
so on and so on. A full list of those types can be found in <A HREF="lua_gf.html">lua_gf.txt</A>.
<FONT COLOR="#00FFFF"> dir,</FONT> is the direction, from the <FONT COLOR="#00FFFF">get_aim_dir()</FONT> bit.
<FONT COLOR="#00FFFF"> damage,</FONT> is the damage. As we've already said, this will be clvl*3.
<FONT COLOR="#00FFFF"> 3)</FONT> is the radius.
and finally...

<FONT COLOR="#00FFFF">  end,</FONT>
<FONT COLOR="#00FFFF">}</FONT>

<FONT COLOR="#00FFFF">end,</FONT> tells it the function has ended. Every function must finish with 
<FONT COLOR="#00FFFF">end</FONT>.
You should have spotted that after the end of each attribute is a comma. Make 
sure you include this, and don't forget the braces at the very very end to 
close the <FONT COLOR="#00FFFF">add_power</FONT> function.

<FONT COLOR="#FF0000">=== Finishing the LUA file ===</FONT>

Save this as a text file 'pheonix.lua' Put it into the lib\scrpt directory 
of ToME, and open the init.lua file which you'll find in the same 
directory. 

Add the following line and resave the init.lua file.

<FONT COLOR="#00FFFF">tome_dofile("pheonix.lua")</FONT>

This ensures that ToME loads your file on start-up. Because you've installed 
the example scripts, this has all been done for you.

<FONT COLOR="#FF0000">=== A quick word about comments ===</FONT>

One of the reason Angband has so many variants is because the source code is 
clearly commented. Almost every line of code has an accompanying comment, 
explaining what that line does. It's good practice to add comments to any code 
or script you write. It's helpful to others who are learning, anyone who takes 
over your project, and also to yourself when you come back in a month's time 
and can't remember what you did! So comment your code clearly, and well!

You can also add multi line comments which should be enclosed by <FONT COLOR="#00FFFF">--[[</FONT> 
and 
<FONT COLOR="#00FFFF">]]</FONT>

<FONT COLOR="#FF0000">=== Tying it all together ===</FONT>

You'll now need to link this 'U' power to the pheonix race via the 
p_info.txt file. Simply add a line within the class definition file that has 
the format <FONT COLOR="#00FFFF">R:Z:<name></FONT>the name of the power as it appears in the 
<FONT COLOR="#00FFFF">"name"</FONT> 
section we did right at the beginning, remember? Seeing as there is no pheonix 
race, I've gone ahead and made one up as a demonstration. If you've downloaded 
and installed the example files from <FONT COLOR="#00FF00">http://www.moppy.co.uk/angband.htm/</FONT> 
then 
you'll notice you already have the pheonix race available. Printed below is 
the p_info.txt entry for it.


<FONT COLOR="#00FFFF">R:N:23:Pheonix</FONT>
<FONT COLOR="#00FFFF">R:D:Born from flame, these powerful bird like creatures gain fire related</FONT>
<FONT COLOR="#00FFFF">R:D:abilities as they grow. </FONT>
<FONT COLOR="#00FFFF">R:S:1:0:2:1:-3:2:-5</FONT>
<FONT COLOR="#00FFFF">R:K:-8:15:20:-10:5:-1:-5:-5</FONT>
<FONT COLOR="#00FFFF">R:P:8:130:5:210</FONT>
<FONT COLOR="#00FFFF">R:M:255:70:2:1:20:5:2:1:18:3</FONT>
<FONT COLOR="#00FFFF">R:E:1:1:1:2:1:1</FONT>
<FONT COLOR="#00FFFF">R:C:Warrior | Mage | Priest | Rogue | Ranger | Paladin | Blade | </FONT>
<FONT COLOR="#00FFFF">R:C:Warlock | Chaos-Warrior | Monk | Mindcrafter | High-Mage |</FONT>
<FONT COLOR="#00FFFF">R:C:BeastMaster | Alchemist |  Power-Mage | Runecrafter | </FONT>
<FONT COLOR="#00FFFF">R:C:Sorceror | Archer | Illusionist | Druid | Necromancer | Black-Knight </FONT>
| 
<FONT COLOR="#00FFFF">R:C:Daemonologist | Weaponmaster | Summoner | </FONT>
<FONT COLOR="#00FFFF">R:Z:Fire Ball</FONT>
<FONT COLOR="#00FFFF">R:R:1:0</FONT>
<FONT COLOR="#00FFFF">R:F:RES_FIRE | FEATHER |</FONT>

Note the <FONT COLOR="#00FFFF">R:Z:</FONT> line. 

If all is well, you should be able to start ToME now and breathe fire! Once 
you get to lvl 10 anyhow. Don't forget, this is the kind of thing wizard mode 
was invented for! Ctrl-A and confirm at the prompt, and then 'e' will allow 
you to alter stats, including experience. Approx 1000 exp should do to get you 
to clvl 10.

Ready for more? How about adding a new <A HREF="lua_skil.html">skill</A> ?

                             <FONT COLOR="#008040">This file by fearoffours (fearoffours@moppy.co.uk)</FONT>




</TT></PRE>
</FONT>
</body>
</html>
